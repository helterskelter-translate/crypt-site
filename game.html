<script>
    // Инициализация страницы игры
    document.addEventListener('DOMContentLoaded', function() {
        loadGameDetails();
        
        // Поиск
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    window.location.href = `all.html?search=${encodeURIComponent(query)}`;
                }
            }
        });
        
        // Мобильное меню
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        mobileMenuBtn.addEventListener('click', function() {
            document.querySelector('.nav').classList.toggle('active');
        });
        
        // Обработчики для кнопок авторов
        document.querySelectorAll('.nav-link[data-author]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const author = this.dataset.author;
                window.location.href = `all.html?author=${author}`;
            });
        });
    });
    
    // Функция загрузки деталей игры
    async function loadGameDetails() {
        try {
            // Пробуем получить slug из разных источников
            let gameSlug = null;
            
            // 1. Из sessionStorage (при переходе с физической страницы)
            gameSlug = sessionStorage.getItem('currentGameSlug');
            if (gameSlug) {
                sessionStorage.removeItem('currentGameSlug'); // Очищаем после использования
            }
            
            // 2. Из URL параметров (старый способ или резервный)
            if (!gameSlug) {
                const urlParams = new URLSearchParams(window.location.search);
                gameSlug = urlParams.get('slug');
            }
            
            // 3. Из пути URL (человеко-понятный URL уже обработан Netlify)
            if (!gameSlug && window.location.pathname.includes('game.html')) {
                // Если мы на game.html без параметров, редиректим на главную
                window.location.href = '/';
                return;
            }
            
            if (!gameSlug) {
                showError('Игра не указана. Вернитесь на главную страницу и выберите игру.');
                return;
            }
            
            // Загружаем данные игр
            const response = await fetch('data/games.json');
            if (!response.ok) throw new Error('Не удалось загрузить данные');
            
            const games = await response.json();
            const game = games.find(g => g.slug === gameSlug);
            
            if (!game) {
                showError('Игра не найдена в базе данных.');
                return;
            }
            
            // Отображаем игру
            displayGameDetails(game);
            updatePageTitle(game);
            
            // Обновляем URL в истории браузера на красивый
            window.history.replaceState({}, '', `/game/${gameSlug}`);
            
        } catch (error) {
            console.error('Ошибка загрузки деталей игры:', error);
            showError('Не удалось загрузить информацию об игре.');
        }
    }
    
    // Функция отображения ошибки
    function showError(message) {
        const container = document.getElementById('game-container');
        if (container) {
            container.innerHTML = `
                <div class="no-results">
                    <p>${message}</p>
                    <a href="/" class="btn">Вернуться на главную</a>
                </div>
            `;
        }
    }
</script>